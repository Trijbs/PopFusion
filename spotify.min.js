!function(){"use strict";const e=document.getElementById("spotify-grid"),t=document.getElementById("load-more"),n=document.getElementById("genre-filter"),r=document.getElementById("search-input"),o=document.querySelector(".spinner"),a=document.querySelector(".error-message"),i=CONFIG.SPOTIFY_CLIENT_ID,s=CONFIG.SPOTIFY_CLIENT_SECRET,l=CONFIG.SPOTIFY_PLAYLIST_ID,c=CONFIG.ITEMS_PER_PAGE,d=CONFIG.CACHE_DURATION,u=CONFIG.FALLBACK_IMAGE;let f=0,p=[],g=[],m=new Audio;const h=[{name:"New Song 1",artist:"New Artist 1",genre:"Pop",image:"https://images.pexels.com/photos/167636/pexels-photo-167636.jpeg",url:"#",preview_url:""},{name:"New Song 2",artist:"New Artist 2",genre:"Hip-Hop",image:"https://images.pexels.com/photos/96380/pexels-photo-96380.jpeg",url:"#",preview_url:""},{name:"New Song 3",artist:"New Artist 3",genre:"Electronic",image:"https://images.pexels.com/photos/210922/pexels-photo-210922.jpeg",url:"#",preview_url:""}];async function y(){try{const e=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:"Basic "+btoa(i+":"+s)},body:"grant_type=client_credentials"});return(await e.json()).access_token}catch(e){return console.error("Error fetching Spotify token:",e),null}}async function b(e,n){try{const r=await fetch(`https://api.spotify.com/v1/artists/${e}`,{headers:{Authorization:`Bearer ${n}`}});const o=await r.json();return o.genres&&o.genres.length?o.genres[0]:"Unknown"}catch(e){return console.error("Error fetching artist genres:",e),"Unknown"}}async function v(){const e=`spotify_cache_${l}`,t=localStorage.getItem(e);if(t){const e=JSON.parse(t);if(Date.now()-e.timestamp<d)return e.data}const n=await y();if(!n)return console.warn("Using fallback data due to Spotify API failure"),h;try{const e=await fetch(`https://api.spotify.com/v1/playlists/${l}/tracks?limit=50`,{headers:{Authorization:`Bearer ${n}`}});const r=(await e.json()).items,o=await Promise.all(r.map(async e=>{const r=e.track,o=r.artists[0].id,a=await b(o,n);return{name:DOMPurify.sanitize(r.name),artist:DOMPurify.sanitize(r.artists[0].name),genre:a,image:r.album.images[0]?.url||u,url:r.external_urls.spotify,preview_url:r.preview_url||""}}));return localStorage.setItem(e,JSON.stringify({data:o,timestamp:Date.now()})),o}catch(e){return console.error("Error fetching Spotify tracks:",e),h}}function w(t,n=!1){n||(e.innerHTML=""),t.forEach(t=>{const n=document.createElement("div");n.className="spotify-card",n.setAttribute("role","article"),n.setAttribute("data-genre",t.genre),n.innerHTML=`<img src="${u}" data-src="${t.image}" alt="${t.name} cover" loading="lazy"><div class="card-details"><h3>${t.name}</h3><p>Artist: ${t.artist}</p><p>Genre: ${t.genre}</p><a href="${t.url}" target="_blank" rel="noopener noreferrer" class="listen-now" data-tooltip="Stream on Spotify" aria-label="Listen to ${t.name}">Listen Now</a>${t.preview_url?`<button class="play-preview" data-preview="${t.preview_url}" data-tooltip="Play 30-second preview" aria-label="Play preview of ${t.name}">Play Preview</button>`:""}</div>`,e.appendChild(n)}),k()}function k(){const t=new IntersectionObserver((e,n)=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target;t.src=t.dataset.src,t.removeAttribute("data-src"),n.unobserve(t)}})},{rootMargin:"100px"});e.querySelectorAll("img[data-src]").forEach(e=>t.observe(e))}function S(){const n=f*c,r=n+c,o=g.slice(n,r);w(o,f>0),f++,r>=g.length&&(t.disabled=!0),o.length&&o[0].name&&e.scrollIntoView({behavior:"smooth",block:"start"})}function x(e){const t=r.value.toLowerCase();g="all"===e?p:p.filter(n=>n.genre===e),t&&(g=g.filter(e=>e.name.toLowerCase().includes(t)||e.artist.toLowerCase().includes(t))),f=0,t.disabled=!1,S()}async function P(){o.classList.add("active"),a.classList.remove("active");try{p=await v(),x(n.value)}catch(e){a.textContent="Failed to load playlists. Please try again later.",a.classList.add("active")}finally{o.classList.remove("active")}}document.addEventListener("DOMContentLoaded",()=>{P(),n.addEventListener("change",e=>x(e.target.value)),t.addEventListener("click",S),r.addEventListener("input",()=>{x(n.value)}),e.addEventListener("click",e=>{if(e.target.classList.contains("play-preview")){const t=e.target.dataset.preview;t&&(m.src===t&&m.paused?(m.play(),e.target.textContent="Pause Preview"):(m.pause(),m.src=t,m.play(),e.target.textContent="Pause Preview",e.target.addEventListener("click",()=>{m.paused?(m.play(),e.target.textContent="Pause Preview"):(m.pause(),e.target.textContent="Play Preview")}))}}),document.querySelector(".create-playlist").addEventListener("click",()=>{alert("Playlist creation coming soon! Sign in to create custom playlists.")}),document.addEventListener("keydown",e=>{"f"===e.key&&e.ctrlKey&&(e.preventDefault(),n.focus())})})}();